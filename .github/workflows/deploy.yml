name: Deploy to Timeweb

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy over SSH (atomic releases)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_HOST }}          # напр. 147.45.185.209
          username: ${{ secrets.SERVER_USER }}      # напр. deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}       # приватный ключ без пароля
          port: 22
          envs: SERVER_PATH
          script_stop: true
          script: |
            set -euo pipefail

            SERVER_PATH="${{ secrets.SERVER_PATH }}"   # напр. /var/www/VoltHomeBackend
            RELEASES_DIR="$SERVER_PATH/releases"
            CURRENT_LINK="$SERVER_PATH/current"
            TS="$(date +%Y%m%d%H%M%S)"
            RELEASE_DIR="$RELEASES_DIR/$TS"

            echo "[1/8] prepare directories"
            mkdir -p "$RELEASES_DIR"
            cd "$SERVER_PATH"

            echo "[2/8] fetch repo"
            git fetch --all --prune

            echo "[3/8] export clean tree to $RELEASE_DIR"
            mkdir -p "$RELEASE_DIR"
            # экспорт только отслеживаемых файлов (без .git, без старых node_modules)
            git archive origin/main | tar -x -C "$RELEASE_DIR"

            echo "[3.5/8] sync .env into new release (dotenv/config needs it)"
            if [ -f "$SERVER_PATH/.env" ]; then
              cp "$SERVER_PATH/.env" "$RELEASE_DIR/.env"
              echo "  - .env copied into release"
            else
              echo "  ! WARNING: $SERVER_PATH/.env not found; app may fail DB check"
            fi

            echo "[4/8] install production deps (local npm cache)"
            cd "$RELEASE_DIR"
            export NODE_ENV=production
            export npm_config_cache="$RELEASE_DIR/.npm-cache"
            mkdir -p "$npm_config_cache"
            npm ci --omit=dev --no-audit --no-fund

            echo "[5/8] symlink switch to new release"
            ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"

            echo "[6/8] pm2 start/reload (stable)"
            export PM2_HOME="/home/${{ secrets.SERVER_USER }}/.pm2"
            export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"

            /usr/bin/pm2 -v || true
            /usr/bin/node -v || true

            # гарантируем живой демон
            /usr/bin/pm2 ping >/dev/null 2>&1 || /usr/bin/pm2 resurrect >/dev/null 2>&1 || true

            if /usr/bin/pm2 describe volthome-api >/dev/null 2>&1; then
              /usr/bin/pm2 reload volthome-api --update-env
            else
              /usr/bin/pm2 start "$CURRENT_LINK/server/server.js" \
                --name volthome-api \
                --cwd "$CURRENT_LINK" \
                --time
            fi
            /usr/bin/pm2 save || true
            /usr/bin/pm2 ls || true

            echo "[7/8] healthcheck + diagnostics + keep 5 releases"
            # быстрые проверки слушающего порта (диагностика)
            (ss -tulpn 2>/dev/null | grep ':3000' || true)

            # healthcheck (30 попыток по 1с)
            for i in $(seq 1 30); do
              if curl -fsS http://127.0.0.1:3000/health >/dev/null; then
                echo "health OK on try $i ✅"
                break
              fi
              echo "waiting app to become healthy... ($i/30)"
              sleep 1
            done

            if ! curl -fsS http://127.0.0.1:3000/health >/dev/null; then
              echo "healthcheck failed, printing pm2 + app logs ⬇️"
              /usr/bin/pm2 ls || true
              # вывести именно логи приложения
              tail -n 200 "/home/${{ secrets.SERVER_USER }}/.pm2/logs/volthome-api-error.log" 2>/dev/null || true
              tail -n 200 "/home/${{ secrets.SERVER_USER }}/.pm2/logs/volthome-api-out.log"   2>/dev/null || true
              # жёсткий перезапуск (fallback)
              /usr/bin/pm2 delete volthome-api || true
              /usr/bin/pm2 start "$CURRENT_LINK/server/server.js" --name volthome-api --cwd "$CURRENT_LINK" --time
              /usr/bin/pm2 save || true
              # повторная проверка
              sleep 2
              curl -fsS http://127.0.0.1:3000/health >/dev/null || exit 1
            fi

            # оставить только 5 последних релизов
            ls -1dt "$RELEASES_DIR"/* 2>/dev/null | tail -n +6 | xargs -r rm -rf

            echo "✅ deploy finished: $RELEASE_DIR"